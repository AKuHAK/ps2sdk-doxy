<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ps2sdk: ee/sbv/include/sbv_patches.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="code.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ps2sdk
   &#160;<span id="projectnumber">1.1</span>
   </div>
   <div id="projectbrief">A collection of Open Source libraries used for developing applications on Sony&#39;s PlayStation 2Â® (PS2).</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('sbv__patches_8h.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">sbv_patches.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> This graph shows which files directly or indirectly include this file:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="sbv__patches_8h__dep__incl.svg" width="100%" height="406"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
</div>
<p><a href="sbv__patches_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ab869b0259adf3e07c89c791b1c32b41c"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sbv__patches_8h.html#ab869b0259adf3e07c89c791b1c32b41c">sbv_patch_enable_lmb</a> (void)</td></tr>
<tr class="separator:ab869b0259adf3e07c89c791b1c32b41c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a71afad23268059645cd9a8310ee59223"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sbv__patches_8h.html#a71afad23268059645cd9a8310ee59223">sbv_patch_disable_prefix_check</a> (void)</td></tr>
<tr class="separator:a71afad23268059645cd9a8310ee59223"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aae2a4b6f2246429c5ead8c072d022f7b"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sbv__patches_8h.html#aae2a4b6f2246429c5ead8c072d022f7b">sbv_patch_user_mem_clear</a> (void *start)</td></tr>
<tr class="separator:aae2a4b6f2246429c5ead8c072d022f7b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aadd4c87782dd3cd922e0e7cf797843ee"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="sbv__patches_8h.html#aadd4c87782dd3cd922e0e7cf797843ee">sbv_patch_fileio</a> (void)</td></tr>
<tr class="separator:aadd4c87782dd3cd922e0e7cf797843ee"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>SBV patches. </p>

<p class="definition">Definition in file <a class="el" href="sbv__patches_8h_source.html">sbv_patches.h</a>.</p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a71afad23268059645cd9a8310ee59223"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a71afad23268059645cd9a8310ee59223">&#9670;&nbsp;</a></span>sbv_patch_disable_prefix_check()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sbv_patch_disable_prefix_check </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="section return"><dt>Returns</dt><dd>0: success, none-zero: error</dd></dl>
<p>The MODLOAD module has a black/white (depends on version) list that determines what devices can have unprotected EE/IOP executables loaded from. Typically, only protected executables can be loaded from user-writable media like the memory card or HDD unit. This patch will disable the black/white list, allowing executables to be freely loaded from any device. </p>

<p class="definition">Definition at line <a class="el" href="patch__disable__prefix__check_8c_source.html#l00024">24</a> of file <a class="el" href="patch__disable__prefix__check_8c_source.html">patch_disable_prefix_check.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;{</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;        <span class="keyword">union </span>{</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;                <a class="code" href="tamtypes_8h.html#aed742c436da53c1080638ce6ef7d13de">u8</a> buf[256];</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;                <a class="code" href="structslib__exp__lib__t.html">slib_exp_lib_t</a> exp_lib;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;        } buf;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;        <span class="keyword">static</span> <a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> patch[2] <a class="code" href="kernel_8h.html#a8e7a3bf6003d72a62606f343c2db6245">ALIGNED</a>(16)={</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;                0x03e00008,     <span class="comment">/* jr $ra */</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;                0x00001021      <span class="comment">/* addiu $v0, $0, 0 */</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        };</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;        <a class="code" href="structSifDmaTransfer__t.html">SifDmaTransfer_t</a> dmat;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;        <a class="code" href="structslib__exp__lib__t.html">slib_exp_lib_t</a> *modload_lib = &amp;buf.exp_lib;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160; </div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;        memset(&amp;<a class="code" href="patch__disable__prefix__check_8c.html#a59c5cf57120c65f8a947fe6140596851">_slib_cur_exp_lib_list</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structslib__exp__lib__list__t.html">slib_exp_lib_list_t</a>));</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160; </div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="slib_8h.html#a9fec18f9dcb7941cfcc6cc874e7192ef">slib_get_exp_lib</a>(<span class="stringliteral">&quot;modload&quot;</span>, modload_lib))</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160; </div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;        dmat.<a class="code" href="structSifDmaTransfer__t.html#ae58a803a6593aa3ea56aae3f44cd03af">src</a>=patch;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        dmat.<a class="code" href="structSifDmaTransfer__t.html#aa095dc74c5c080a1c1cfc69ee4885f87">size</a>=<span class="keyword">sizeof</span>(patch);        <span class="comment">//16-bytes will be written to IOP RAM, but the function on the IOP side is longer than 16 bytes in length.</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        dmat.<a class="code" href="structSifDmaTransfer__t.html#acb6defff65e747d386b28aa756c51575">dest</a>=modload_lib-&gt;<a class="code" href="structslib__exp__lib__t.html#acd83b1c2916941eee1e9a1828f58e603">exports</a>[15];</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        dmat.<a class="code" href="structSifDmaTransfer__t.html#abea4132eac1b82deda7743010469012e">attr</a>=0;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160; </div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        <a class="code" href="kernel_8h.html#a2b8881e2a24bee9c3f14c7005ff1f744">SifSetDma</a>(&amp;dmat, 1);</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160; </div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;}</div>
<div class="ttc" id="akernel_8h_html_a2b8881e2a24bee9c3f14c7005ff1f744"><div class="ttname"><a href="kernel_8h.html#a2b8881e2a24bee9c3f14c7005ff1f744">SifSetDma</a></div><div class="ttdeci">u32 SifSetDma(SifDmaTransfer_t *sdd, s32 len)</div></div>
<div class="ttc" id="akernel_8h_html_a8e7a3bf6003d72a62606f343c2db6245"><div class="ttname"><a href="kernel_8h.html#a8e7a3bf6003d72a62606f343c2db6245">ALIGNED</a></div><div class="ttdeci">#define ALIGNED(x)</div><div class="ttdef"><b>Definition:</b> <a href="kernel_8h_source.html#l00050">kernel.h:50</a></div></div>
<div class="ttc" id="apatch__disable__prefix__check_8c_html_a59c5cf57120c65f8a947fe6140596851"><div class="ttname"><a href="patch__disable__prefix__check_8c.html#a59c5cf57120c65f8a947fe6140596851">_slib_cur_exp_lib_list</a></div><div class="ttdeci">slib_exp_lib_list_t _slib_cur_exp_lib_list</div><div class="ttdef"><b>Definition:</b> <a href="slib_8c_source.html#l00026">slib.c:26</a></div></div>
<div class="ttc" id="aslib_8h_html_a9fec18f9dcb7941cfcc6cc874e7192ef"><div class="ttname"><a href="slib_8h.html#a9fec18f9dcb7941cfcc6cc874e7192ef">slib_get_exp_lib</a></div><div class="ttdeci">int slib_get_exp_lib(const char *name, slib_exp_lib_t *library)</div><div class="ttdef"><b>Definition:</b> <a href="slib_8c_source.html#l00101">slib.c:101</a></div></div>
<div class="ttc" id="astructSifDmaTransfer__t_html"><div class="ttname"><a href="structSifDmaTransfer__t.html">SifDmaTransfer_t</a></div><div class="ttdef"><b>Definition:</b> <a href="sifdma_8h_source.html#l00052">sifdma.h:53</a></div></div>
<div class="ttc" id="astructSifDmaTransfer__t_html_aa095dc74c5c080a1c1cfc69ee4885f87"><div class="ttname"><a href="structSifDmaTransfer__t.html#aa095dc74c5c080a1c1cfc69ee4885f87">SifDmaTransfer_t::size</a></div><div class="ttdeci">int size</div><div class="ttdef"><b>Definition:</b> <a href="sifdma_8h_source.html#l00056">sifdma.h:56</a></div></div>
<div class="ttc" id="astructSifDmaTransfer__t_html_abea4132eac1b82deda7743010469012e"><div class="ttname"><a href="structSifDmaTransfer__t.html#abea4132eac1b82deda7743010469012e">SifDmaTransfer_t::attr</a></div><div class="ttdeci">int attr</div><div class="ttdef"><b>Definition:</b> <a href="sifdma_8h_source.html#l00057">sifdma.h:57</a></div></div>
<div class="ttc" id="astructSifDmaTransfer__t_html_acb6defff65e747d386b28aa756c51575"><div class="ttname"><a href="structSifDmaTransfer__t.html#acb6defff65e747d386b28aa756c51575">SifDmaTransfer_t::dest</a></div><div class="ttdeci">void * dest</div><div class="ttdef"><b>Definition:</b> <a href="sifdma_8h_source.html#l00055">sifdma.h:55</a></div></div>
<div class="ttc" id="astructSifDmaTransfer__t_html_ae58a803a6593aa3ea56aae3f44cd03af"><div class="ttname"><a href="structSifDmaTransfer__t.html#ae58a803a6593aa3ea56aae3f44cd03af">SifDmaTransfer_t::src</a></div><div class="ttdeci">void * src</div><div class="ttdef"><b>Definition:</b> <a href="sifdma_8h_source.html#l00054">sifdma.h:54</a></div></div>
<div class="ttc" id="astructslib__exp__lib__list__t_html"><div class="ttname"><a href="structslib__exp__lib__list__t.html">slib_exp_lib_list_t</a></div><div class="ttdef"><b>Definition:</b> <a href="slib_8h_source.html#l00045">slib.h:45</a></div></div>
<div class="ttc" id="astructslib__exp__lib__t_html"><div class="ttname"><a href="structslib__exp__lib__t.html">slib_exp_lib_t</a></div><div class="ttdef"><b>Definition:</b> <a href="slib_8h_source.html#l00032">slib.h:32</a></div></div>
<div class="ttc" id="astructslib__exp__lib__t_html_acd83b1c2916941eee1e9a1828f58e603"><div class="ttname"><a href="structslib__exp__lib__t.html#acd83b1c2916941eee1e9a1828f58e603">slib_exp_lib_t::exports</a></div><div class="ttdeci">void * exports[0]</div><div class="ttdef"><b>Definition:</b> <a href="slib_8h_source.html#l00038">slib.h:38</a></div></div>
<div class="ttc" id="atamtypes_8h_html_a10e94b422ef0c20dcdec20d31a1f5049"><div class="ttname"><a href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a></div><div class="ttdeci">unsigned int u32</div><div class="ttdef"><b>Definition:</b> <a href="tamtypes_8h_source.html#l00030">tamtypes.h:30</a></div></div>
<div class="ttc" id="atamtypes_8h_html_aed742c436da53c1080638ce6ef7d13de"><div class="ttname"><a href="tamtypes_8h.html#aed742c436da53c1080638ce6ef7d13de">u8</a></div><div class="ttdeci">unsigned char u8</div><div class="ttdef"><b>Definition:</b> <a href="tamtypes_8h_source.html#l00023">tamtypes.h:23</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="slib_8c_source.html#l00026">_slib_cur_exp_lib_list</a>, <a class="el" href="kernel_8h_source.html#l00050">ALIGNED</a>, <a class="el" href="sifdma_8h_source.html#l00057">SifDmaTransfer_t::attr</a>, <a class="el" href="sifdma_8h_source.html#l00055">SifDmaTransfer_t::dest</a>, <a class="el" href="slib_8h_source.html#l00038">slib_exp_lib_t::exports</a>, <a class="el" href="kernel_8h.html#a2b8881e2a24bee9c3f14c7005ff1f744">SifSetDma()</a>, <a class="el" href="sifdma_8h_source.html#l00056">SifDmaTransfer_t::size</a>, <a class="el" href="slib_8c_source.html#l00101">slib_get_exp_lib()</a>, and <a class="el" href="sifdma_8h_source.html#l00054">SifDmaTransfer_t::src</a>.</p>

</div>
</div>
<a id="ab869b0259adf3e07c89c791b1c32b41c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab869b0259adf3e07c89c791b1c32b41c">&#9670;&nbsp;</a></span>sbv_patch_enable_lmb()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sbv_patch_enable_lmb </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="section return"><dt>Returns</dt><dd>0: success, none-zero: error</dd></dl>
<p>The rom0:LOADFILE RPC service is missing support for LoadModuleBuffer, making it impossible (by default) to IOP load modules from EE RAM. Newer LOADFILE modules do not have this limitation. Unlike the official patch, this version is not dependent on 0x01e00000-0x01e80000. </p>

<p class="definition">Definition at line <a class="el" href="patch__enable__lmb_8c_source.html#l00038">38</a> of file <a class="el" href="patch__enable__lmb_8c_source.html">patch_enable_lmb.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;{</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;        <span class="comment">/* This is the routine called by the loadfile RPC dispatcher for LoadModuleBuffer</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">           over RPC (call #6).  The bracketed operands are the ones patched by the real</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">           locations in IOP memory before being installed onto the IOP.  */</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        <span class="keyword">static</span> <a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> lmb_patch[32] <a class="code" href="kernel_8h.html#a8e7a3bf6003d72a62606f343c2db6245">ALIGNED</a>(64) = {</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;                0x27bdffd8,     <span class="comment">/*      addiu   $sp, -40        */</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;                0xafb00018,     <span class="comment">/*      sw      $s0, 0x18($sp)  */</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;                0xafbf0020,     <span class="comment">/*      sw      $ra, 0x20($sp)  */</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;                0x00808021,     <span class="comment">/*      move    $s0, $a0        */</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;                0x8c840000,     <span class="comment">/*      lw      $a0, 0($a0)     */</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;                0x0c000000,     <span class="comment">/*      jal     [LoadModuleBuffer] */</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;                0xafb1001c,     <span class="comment">/*       sw     $s1, 0x1c($sp)  */</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;                0x3c110000,     <span class="comment">/*      lui     $s1, [HI16(result)] */</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;                0x04400008,     <span class="comment">/*      bltz    $v0, 1f         */</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;                0x36310000,     <span class="comment">/*       ori    $s1, [LO16(result)] */</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;                0x00402021,     <span class="comment">/*      move    $a0, $v0        */</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;                0x26250008,     <span class="comment">/*      addiu   $a1, $s1, 8     */</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;                0x8e060004,     <span class="comment">/*      lw      $a2, 4($s0)     */</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;                0x26070104,     <span class="comment">/*      addiu   $a3, $s0, 0x104 */</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;                0x26280004,     <span class="comment">/*      addiu   $t0, $s1, 4     */</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;                0x0c000000,     <span class="comment">/*      jal     [StartModule]   */</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;                0xafa80010,     <span class="comment">/*       sw     $t0, 0x10($sp)  */</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;                0xae220000,     <span class="comment">/* 1:   sw      $v0, 0($s1)     */</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;                0x02201021,     <span class="comment">/*      move    $v0, $s1        */</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;                0x8fbf0020,     <span class="comment">/*      lw      $ra, 0x20($sp)  */</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;                0x8fb1001c,     <span class="comment">/*      lw      $s1, 0x1c($sp)  */</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;                0x8fb00018,     <span class="comment">/*      lw      $s0, 0x18($sp)  */</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;                0x03e00008,     <span class="comment">/*      jr      $ra             */</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                0x27bd0028,     <span class="comment">/*       addiu  $sp, 40         */</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;                0x00000000, 0x00000000,</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;                0x7962424c, 0x00004545, <span class="comment">/* &quot;LBbyEE&quot; */</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;                0x00000000, 0x00000000, 0x00000000, 0x00000000</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        };</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        <a class="code" href="tamtypes_8h.html#aed742c436da53c1080638ce6ef7d13de">u8</a> buf[256];</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        <a class="code" href="structSifRpcReceiveData__t.html">SifRpcReceiveData_t</a> RData;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        <a class="code" href="structslib__exp__lib__t.html">slib_exp_lib_t</a> *modload_lib = (<a class="code" href="structslib__exp__lib__t.html">slib_exp_lib_t</a> *)buf;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        <a class="code" href="structsmod__mod__info__t.html">smod_mod_info_t</a> loadfile_info;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        <span class="keywordtype">void</span> *pStartModule, *pLoadModuleBuffer, *patch_addr, *lf_rpc_dispatch, *lf_jump_table_end, *lf_fno_check;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> JumpTableOffset_hi, JumpTableOffset_lo;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        <a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> <a class="code" href="rpc__client_8c.html#afb717615b61a4425017ab21735e06042">result</a>, *<a class="code" href="libmouse_8c.html#a0e5b72ac4f845f11204b39c8fb0f5d91">data</a>;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        <span class="keywordtype">int</span> id;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        <a class="code" href="structSifDmaTransfer__t.html">SifDmaTransfer_t</a> dmat;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160; </div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        memset(&amp;<a class="code" href="patch__enable__lmb_8c.html#a59c5cf57120c65f8a947fe6140596851">_slib_cur_exp_lib_list</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structslib__exp__lib__list__t.html">slib_exp_lib_list_t</a>));</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160; </div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="comment">/* Locate the modload export library - it must have at least 16 exports.  */</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="slib_8h.html#a9fec18f9dcb7941cfcc6cc874e7192ef">slib_get_exp_lib</a>(<span class="stringliteral">&quot;modload&quot;</span>, modload_lib) &lt; 16)</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160; </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        pStartModule = modload_lib-&gt;<a class="code" href="structslib__exp__lib__t.html#acd83b1c2916941eee1e9a1828f58e603">exports</a>[8];</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        pLoadModuleBuffer = modload_lib-&gt;<a class="code" href="structslib__exp__lib__t.html#acd83b1c2916941eee1e9a1828f58e603">exports</a>[10];</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160; </div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        <span class="comment">/* Now we need to find the loadfile module.  */</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        <span class="keywordflow">if</span> (!(<span class="keywordtype">id</span> = <a class="code" href="smod_8h.html#afe5e72209692b56a9ffd4bdccbf41ac5">smod_get_mod_by_name</a>(<span class="stringliteral">&quot;LoadModuleByEE&quot;</span>, &amp;loadfile_info)))</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="comment">/*      In the Sony original, the whole text section of LOADFILE is scanned for the pattern.</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">                But that required a larger portion of EE RAM, which means that memory</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">                will have to be allocated. It will also mean that this library will become dependent on additional memory (i.e. 0x01e00000-0x01e80000).</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">                I think that it&#39;s fine to hardcode the address because the affected LOADFILE module is the same in all boot ROMs.</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment">                If someday, somebody finds an unusual (perhaps even prototype) PlayStation 2 console that has an older LOADFILE module that needs this patch too,</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">                this patch can be revised.</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">                The original sbv library&#39;s LMB patch starts scanning at offset 0x400, in a mere 256-byte radius.</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment">                        Locate the loadfile RPC dispatch code, where the first 4 instructions look like:</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment">                        27bdffe8        addiu   $sp, -24</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">                        2c820006        sltiu   $v0, $a0, 6</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">                        14400003        bnez    $v0, +12</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">                        afbf0010        sw      $ra, 0x10($sp)  */</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160; </div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        <span class="keywordflow">if</span>(loadfile_info.<a class="code" href="structsmod__mod__info__t.html#ab6e4009b66463756497c2a5ba9e20cfc">text_size</a> &lt; 0x4c4 + 128)</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160; </div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        lf_rpc_dispatch = (<span class="keywordtype">void</span> *)(loadfile_info.<a class="code" href="structsmod__mod__info__t.html#ab29a3d44cffc76417e66427cda3b6b39">text_start</a> + 0x4c4);</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <a class="code" href="kernel_8h.html#a7481825d395b8b88606c147782588902">SyncDCache</a>(&amp;<a class="code" href="structsmem__buf.html">smem_buf</a>, <a class="code" href="structsmem__buf.html">smem_buf</a>.<a class="code" href="structsmem__buf.html#a074a25b7b5553a8a071e05af0a72725a">bytes</a>+128);</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="sifrpc_8h.html#a816a9e4609ecbe71878d9c756e9e74a6">SifRpcGetOtherData</a>(&amp;RData, (<span class="keywordtype">void</span>*)lf_rpc_dispatch, &amp;<a class="code" href="structsmem__buf.html">smem_buf</a>, 128, 0)&gt;=0){</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                <a class="code" href="libmouse_8c.html#a0e5b72ac4f845f11204b39c8fb0f5d91">data</a>=<a class="code" href="structsmem__buf.html">smem_buf</a>.<a class="code" href="structsmem__buf.html#aadeb593031aea2717d908f88286434cd">words</a>;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                <span class="keywordflow">if</span>(<a class="code" href="libmouse_8c.html#a0e5b72ac4f845f11204b39c8fb0f5d91">data</a>[0]==0x27bdffe8 &amp;&amp; <a class="code" href="libmouse_8c.html#a0e5b72ac4f845f11204b39c8fb0f5d91">data</a>[1]==0x2c820006 &amp;&amp; <a class="code" href="libmouse_8c.html#a0e5b72ac4f845f11204b39c8fb0f5d91">data</a>[2]==0x14400003 &amp;&amp; <a class="code" href="libmouse_8c.html#a0e5b72ac4f845f11204b39c8fb0f5d91">data</a>[3]==0xafbf0010 &amp;&amp; <a class="code" href="libmouse_8c.html#a0e5b72ac4f845f11204b39c8fb0f5d91">data</a>[5]==0x00001021 &amp;&amp; <a class="code" href="libmouse_8c.html#a0e5b72ac4f845f11204b39c8fb0f5d91">data</a>[6]==0x00041080){</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                        lf_fno_check = (<span class="keywordtype">void</span>*)(lf_rpc_dispatch+4);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160; </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                        <span class="comment">/* We need to extract the address of the jump table. */</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                        JumpTableOffset_hi=*(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>*)&amp;<a class="code" href="libmouse_8c.html#a0e5b72ac4f845f11204b39c8fb0f5d91">data</a>[7];</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                        JumpTableOffset_lo=*(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>*)&amp;<a class="code" href="libmouse_8c.html#a0e5b72ac4f845f11204b39c8fb0f5d91">data</a>[9];</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160; </div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                        lf_jump_table_end = (<span class="keywordtype">void</span>*)((JumpTableOffset_hi&lt;&lt;16) + (<span class="keywordtype">short</span> int)JumpTableOffset_lo + 0x18);</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160; </div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                        <span class="comment">/* Now we can patch our subversive LoadModuleBuffer RPC call.  */</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                        <a class="code" href="iopheap_8h.html#adf3f039812fac1c19289aa73460376d8">SifInitIopHeap</a>();</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                        <span class="keywordflow">if</span> ((patch_addr = <a class="code" href="iopheap_8h.html#a3edc638fb035b452cac7f90e307651f2">SifAllocIopHeap</a>(<span class="keyword">sizeof</span> lmb_patch)) == <a class="code" href="tamtypes_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160; </div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                        <span class="comment">/* result is where the RPC return structure is stored.  */</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                        <a class="code" href="rpc__client_8c.html#afb717615b61a4425017ab21735e06042">result</a> = (<a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)patch_addr + 96;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                        lmb_patch[5] = <a class="code" href="patch__enable__lmb_8c.html#ab6bbd226acccedeaac6172bb2e3afe0d">JAL</a>((<a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)pLoadModuleBuffer);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                        lmb_patch[7] = <a class="code" href="patch__enable__lmb_8c.html#a29c26514b87ff9c669a7971e4dc7c068">HI16</a>(<a class="code" href="rpc__client_8c.html#afb717615b61a4425017ab21735e06042">result</a>);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                        lmb_patch[9] = <a class="code" href="patch__enable__lmb_8c.html#ab4b18770729f858cea3718e0eb7ddb7a">LO16</a>(<a class="code" href="rpc__client_8c.html#afb717615b61a4425017ab21735e06042">result</a>);</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                        lmb_patch[15] = <a class="code" href="patch__enable__lmb_8c.html#ab6bbd226acccedeaac6172bb2e3afe0d">JAL</a>((<a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)pStartModule);</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160; </div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                        <a class="code" href="kernel_8h.html#a7481825d395b8b88606c147782588902">SyncDCache</a>(lmb_patch, (<span class="keywordtype">void</span> *)(lmb_patch + 24));</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160; </div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                        dmat.<a class="code" href="structSifDmaTransfer__t.html#ae58a803a6593aa3ea56aae3f44cd03af">src</a>=lmb_patch;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                        dmat.<a class="code" href="structSifDmaTransfer__t.html#aa095dc74c5c080a1c1cfc69ee4885f87">size</a>=<span class="keyword">sizeof</span>(lmb_patch);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                        dmat.<a class="code" href="structSifDmaTransfer__t.html#acb6defff65e747d386b28aa756c51575">dest</a>=patch_addr;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                        dmat.<a class="code" href="structSifDmaTransfer__t.html#abea4132eac1b82deda7743010469012e">attr</a>=0;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160; </div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;                        <a class="code" href="kernel_8h.html#a2b8881e2a24bee9c3f14c7005ff1f744">SifSetDma</a>(&amp;dmat, 1);</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160; </div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                        <span class="comment">/* Finally.  The last thing to do is to patch the loadfile RPC dispatch routine</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">                           so that it will jump to entry #6 in it&#39;s jump table, and to patch the jump</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">                           table itself.  */</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                        <a class="code" href="common_8c.html#a69ca030bd7262895245b2ef2d291bd24">smem_write_word</a>(lf_jump_table_end, (<a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)patch_addr);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                        <a class="code" href="common_8c.html#a69ca030bd7262895245b2ef2d291bd24">smem_write_word</a>(lf_fno_check, 0x2C820007);      <span class="comment">//sltiu v0, a0, $0007</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160; </div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                }</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        }</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160; </div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;}</div>
<div class="ttc" id="acommon_8c_html_a69ca030bd7262895245b2ef2d291bd24"><div class="ttname"><a href="common_8c.html#a69ca030bd7262895245b2ef2d291bd24">smem_write_word</a></div><div class="ttdeci">int smem_write_word(void *address, u32 value)</div><div class="ttdef"><b>Definition:</b> <a href="common_8c_source.html#l00040">common.c:40</a></div></div>
<div class="ttc" id="aiopheap_8h_html_a3edc638fb035b452cac7f90e307651f2"><div class="ttname"><a href="iopheap_8h.html#a3edc638fb035b452cac7f90e307651f2">SifAllocIopHeap</a></div><div class="ttdeci">void * SifAllocIopHeap(int size)</div></div>
<div class="ttc" id="aiopheap_8h_html_adf3f039812fac1c19289aa73460376d8"><div class="ttname"><a href="iopheap_8h.html#adf3f039812fac1c19289aa73460376d8">SifInitIopHeap</a></div><div class="ttdeci">int SifInitIopHeap(void)</div></div>
<div class="ttc" id="akernel_8h_html_a7481825d395b8b88606c147782588902"><div class="ttname"><a href="kernel_8h.html#a7481825d395b8b88606c147782588902">SyncDCache</a></div><div class="ttdeci">void SyncDCache(void *start, void *end)</div></div>
<div class="ttc" id="alibmouse_8c_html_a0e5b72ac4f845f11204b39c8fb0f5d91"><div class="ttname"><a href="libmouse_8c.html#a0e5b72ac4f845f11204b39c8fb0f5d91">data</a></div><div class="ttdeci">u32 data</div><div class="ttdef"><b>Definition:</b> <a href="libmouse_8c_source.html#l00036">libmouse.c:36</a></div></div>
<div class="ttc" id="apatch__enable__lmb_8c_html_a29c26514b87ff9c669a7971e4dc7c068"><div class="ttname"><a href="patch__enable__lmb_8c.html#a29c26514b87ff9c669a7971e4dc7c068">HI16</a></div><div class="ttdeci">#define HI16(addr)</div><div class="ttdef"><b>Definition:</b> <a href="patch__enable__lmb_8c_source.html#l00035">patch_enable_lmb.c:35</a></div></div>
<div class="ttc" id="apatch__enable__lmb_8c_html_a59c5cf57120c65f8a947fe6140596851"><div class="ttname"><a href="patch__enable__lmb_8c.html#a59c5cf57120c65f8a947fe6140596851">_slib_cur_exp_lib_list</a></div><div class="ttdeci">slib_exp_lib_list_t _slib_cur_exp_lib_list</div><div class="ttdef"><b>Definition:</b> <a href="slib_8c_source.html#l00026">slib.c:26</a></div></div>
<div class="ttc" id="apatch__enable__lmb_8c_html_ab4b18770729f858cea3718e0eb7ddb7a"><div class="ttname"><a href="patch__enable__lmb_8c.html#ab4b18770729f858cea3718e0eb7ddb7a">LO16</a></div><div class="ttdeci">#define LO16(addr)</div><div class="ttdef"><b>Definition:</b> <a href="patch__enable__lmb_8c_source.html#l00036">patch_enable_lmb.c:36</a></div></div>
<div class="ttc" id="apatch__enable__lmb_8c_html_ab6bbd226acccedeaac6172bb2e3afe0d"><div class="ttname"><a href="patch__enable__lmb_8c.html#ab6bbd226acccedeaac6172bb2e3afe0d">JAL</a></div><div class="ttdeci">#define JAL(addr)</div><div class="ttdef"><b>Definition:</b> <a href="patch__enable__lmb_8c_source.html#l00034">patch_enable_lmb.c:34</a></div></div>
<div class="ttc" id="arpc__client_8c_html_afb717615b61a4425017ab21735e06042"><div class="ttname"><a href="rpc__client_8c.html#afb717615b61a4425017ab21735e06042">result</a></div><div class="ttdeci">s32 result</div><div class="ttdef"><b>Definition:</b> <a href="rpc__client_8c_source.html#l00023">rpc_client.c:23</a></div></div>
<div class="ttc" id="asifrpc_8h_html_a816a9e4609ecbe71878d9c756e9e74a6"><div class="ttname"><a href="sifrpc_8h.html#a816a9e4609ecbe71878d9c756e9e74a6">SifRpcGetOtherData</a></div><div class="ttdeci">int SifRpcGetOtherData(SifRpcReceiveData_t *rd, void *src, void *dest, int size, int mode)</div></div>
<div class="ttc" id="asmod_8h_html_afe5e72209692b56a9ffd4bdccbf41ac5"><div class="ttname"><a href="smod_8h.html#afe5e72209692b56a9ffd4bdccbf41ac5">smod_get_mod_by_name</a></div><div class="ttdeci">int smod_get_mod_by_name(const char *name, smod_mod_info_t *info)</div><div class="ttdef"><b>Definition:</b> <a href="smod_8c_source.html#l00054">smod.c:54</a></div></div>
<div class="ttc" id="astructSifRpcReceiveData__t_html"><div class="ttname"><a href="structSifRpcReceiveData__t.html">SifRpcReceiveData_t</a></div><div class="ttdef"><b>Definition:</b> <a href="sifrpc_8h_source.html#l00145">sifrpc.h:146</a></div></div>
<div class="ttc" id="astructsmem__buf_html"><div class="ttname"><a href="structsmem__buf.html">smem_buf</a></div><div class="ttdef"><b>Definition:</b> <a href="common_8h_source.html#l00003">common.h:3</a></div></div>
<div class="ttc" id="astructsmem__buf_html_a074a25b7b5553a8a071e05af0a72725a"><div class="ttname"><a href="structsmem__buf.html#a074a25b7b5553a8a071e05af0a72725a">smem_buf::bytes</a></div><div class="ttdeci">u8 bytes[SMEM_BUF_SIZE/sizeof(u8)]</div><div class="ttdef"><b>Definition:</b> <a href="common_8h_source.html#l00005">common.h:5</a></div></div>
<div class="ttc" id="astructsmem__buf_html_aadeb593031aea2717d908f88286434cd"><div class="ttname"><a href="structsmem__buf.html#aadeb593031aea2717d908f88286434cd">smem_buf::words</a></div><div class="ttdeci">u32 words[SMEM_BUF_SIZE/sizeof(u32)]</div><div class="ttdef"><b>Definition:</b> <a href="common_8h_source.html#l00006">common.h:6</a></div></div>
<div class="ttc" id="astructsmod__mod__info__t_html"><div class="ttname"><a href="structsmod__mod__info__t.html">smod_mod_info_t</a></div><div class="ttdef"><b>Definition:</b> <a href="smod_8h_source.html#l00024">smod.h:24</a></div></div>
<div class="ttc" id="astructsmod__mod__info__t_html_ab29a3d44cffc76417e66427cda3b6b39"><div class="ttname"><a href="structsmod__mod__info__t.html#ab29a3d44cffc76417e66427cda3b6b39">smod_mod_info_t::text_start</a></div><div class="ttdeci">u32 text_start</div><div class="ttdef"><b>Definition:</b> <a href="smod_8h_source.html#l00036">smod.h:36</a></div></div>
<div class="ttc" id="astructsmod__mod__info__t_html_ab6e4009b66463756497c2a5ba9e20cfc"><div class="ttname"><a href="structsmod__mod__info__t.html#ab6e4009b66463756497c2a5ba9e20cfc">smod_mod_info_t::text_size</a></div><div class="ttdeci">u32 text_size</div><div class="ttdef"><b>Definition:</b> <a href="smod_8h_source.html#l00037">smod.h:37</a></div></div>
<div class="ttc" id="atamtypes_8h_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="tamtypes_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdef"><b>Definition:</b> <a href="tamtypes_8h_source.html#l00091">tamtypes.h:91</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="slib_8c_source.html#l00026">_slib_cur_exp_lib_list</a>, <a class="el" href="kernel_8h_source.html#l00050">ALIGNED</a>, <a class="el" href="sifdma_8h_source.html#l00057">SifDmaTransfer_t::attr</a>, <a class="el" href="common_8h_source.html#l00005">smem_buf::bytes</a>, <a class="el" href="libmouse_8c_source.html#l00036">data</a>, <a class="el" href="sifdma_8h_source.html#l00055">SifDmaTransfer_t::dest</a>, <a class="el" href="slib_8h_source.html#l00038">slib_exp_lib_t::exports</a>, <a class="el" href="patch__enable__lmb_8c_source.html#l00035">HI16</a>, <a class="el" href="patch__enable__lmb_8c_source.html#l00034">JAL</a>, <a class="el" href="patch__enable__lmb_8c_source.html#l00036">LO16</a>, <a class="el" href="tamtypes_8h_source.html#l00091">NULL</a>, <a class="el" href="rpc__client_8c_source.html#l00023">result</a>, <a class="el" href="iopheap_8h.html#a3edc638fb035b452cac7f90e307651f2">SifAllocIopHeap()</a>, <a class="el" href="iopheap_8h.html#adf3f039812fac1c19289aa73460376d8">SifInitIopHeap()</a>, <a class="el" href="sifrpc_8h.html#a816a9e4609ecbe71878d9c756e9e74a6">SifRpcGetOtherData()</a>, <a class="el" href="kernel_8h.html#a2b8881e2a24bee9c3f14c7005ff1f744">SifSetDma()</a>, <a class="el" href="sifdma_8h_source.html#l00056">SifDmaTransfer_t::size</a>, <a class="el" href="slib_8c_source.html#l00101">slib_get_exp_lib()</a>, <a class="el" href="common_8c_source.html#l00040">smem_write_word()</a>, <a class="el" href="smod_8c_source.html#l00054">smod_get_mod_by_name()</a>, <a class="el" href="sifdma_8h_source.html#l00054">SifDmaTransfer_t::src</a>, <a class="el" href="kernel_8h.html#a7481825d395b8b88606c147782588902">SyncDCache()</a>, <a class="el" href="smod_8h_source.html#l00037">smod_mod_info_t::text_size</a>, <a class="el" href="smod_8h_source.html#l00036">smod_mod_info_t::text_start</a>, and <a class="el" href="common_8h_source.html#l00006">smem_buf::words</a>.</p>

<p class="reference">Referenced by <a class="el" href="samples_2tcpip__basic_2ps2ip_8c_source.html#l00213">main()</a>.</p>

</div>
</div>
<a id="aadd4c87782dd3cd922e0e7cf797843ee"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aadd4c87782dd3cd922e0e7cf797843ee">&#9670;&nbsp;</a></span>sbv_patch_fileio()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sbv_patch_fileio </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="section return"><dt>Returns</dt><dd>0: success, none-zero: error</dd></dl>
<p>The rom0:FILEIO RPC service has several glitches, which either result in stability issues or faulty behaviour:</p><ol type="1">
<li>Interrupts are not disabled when sceSifSetDma is invoked for getstat() and dread(), which could allow simultaneous access into sceSifSetDma (a critical region).</li>
<li>The RPC dispatcher code for remove() has a missing break, resulting in <a class="el" href="ps2sdkapi_8c.html#a548e5b744ca2e97beb61ad7aa41114e2">mkdir()</a> being called after remove() returns. </li>
</ol>

<p class="definition">Definition at line <a class="el" href="patch__fileio_8c_source.html#l00015">15</a> of file <a class="el" href="patch__fileio_8c_source.html">patch_fileio.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;{</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        <span class="comment">/* This patch is a fix for FILEIO on the IOP:</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">                The handler of rpc_fioremove doesn&#39;t exit right after file is</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">                removed due to the break being missing, which ends up</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">                calling the mkdir RPC handler in succession.</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">                A folder with the same name as the deleted file will be created.</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">                We&#39;ll search for FILEIO text section start and patch the rpc</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">                handler to jump to a subroutine to correct this.</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">                The RPC handlers for getstat() and dread() do not suspend interrupts</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">                before invoking sceSifSetDma(), which may result in a race condition</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">                that destroys the internal SIF data structure within SIFMAN.    */</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160; </div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;        <a class="code" href="structsmod__mod__info__t.html">smod_mod_info_t</a> mod_info;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;        <a class="code" href="structSifDmaTransfer__t.html">SifDmaTransfer_t</a> dmat;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        <span class="keyword">static</span> <a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> new_fileio[20] <a class="code" href="kernel_8h.html#a8e7a3bf6003d72a62606f343c2db6245">ALIGNED</a>(16)={</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;                <span class="comment">//sceFioRemove fix</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;                0x0c0001ce,     <span class="comment">// jal          +0x738 &lt;- jal fio_remove</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;                0x00000000,     <span class="comment">// nop</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;                0x0800033a,     <span class="comment">// j            +0xce8 &lt;- j rpc_handler_exit</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;                0x00000000,     <span class="comment">// nop</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;                <span class="comment">//sceFioGetstat()/sceFioDread() fix</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;                0x27bdfff0,     <span class="comment">// addiu        sp,sp,-16</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;                0xafbf0000,     <span class="comment">// sw           ra,0(sp)</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;                0xafa40004,     <span class="comment">// sw           a0,4(sp)</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;                0xafa50008,     <span class="comment">// sw           a1,8(sp)</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;                0x0c000423,     <span class="comment">// jal          +0x108c &lt;- jal CpuSuspendIntr</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;                0x27a4000c,     <span class="comment">// addiu        a0,sp,12</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;                0x8fa40004,     <span class="comment">// lw           a0,4(sp)</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;                0x0c000430,     <span class="comment">// jal          +0x10c0 &lt;- jal sceSifSetDma</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;                0x8fa50008,     <span class="comment">// lw           a1,8(sp)</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;                0x8fa4000c,     <span class="comment">// lw           a0,12(sp)</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;                0x0c000425,     <span class="comment">// jal          +0x1094 &lt;- jal CpuResumeIntr</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;                0xafa20004,     <span class="comment">// sw           v0,4(sp)</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;                0x8fbf0000,     <span class="comment">// lw           ra,0(sp)</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;                0x8fa20004,     <span class="comment">// lw           v0,4(sp)</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;                0x03e00008,     <span class="comment">// jr           ra</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;                0x27bd0010,     <span class="comment">// addiu        sp,sp,16</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;        };</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        <a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> *p_new_fileio;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        <a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> new_jump_op;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        <span class="keywordtype">void</span> *patch_addr;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160; </div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        memset(&amp;mod_info, 0, <span class="keyword">sizeof</span>(mod_info));</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        <span class="keywordtype">int</span> ret = <a class="code" href="smod_8h.html#afe5e72209692b56a9ffd4bdccbf41ac5">smod_get_mod_by_name</a>(<span class="stringliteral">&quot;FILEIO_service&quot;</span>, &amp;mod_info);</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        <span class="keywordflow">if</span> ((!ret) || (mod_info.<a class="code" href="structsmod__mod__info__t.html#a873fac0216a06abf1d451540dba0fd11">version</a> != 0x101))</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160; </div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        <a class="code" href="iopheap_8h.html#adf3f039812fac1c19289aa73460376d8">SifInitIopHeap</a>();</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        <span class="keywordflow">if</span>((patch_addr = <a class="code" href="iopheap_8h.html#a3edc638fb035b452cac7f90e307651f2">SifAllocIopHeap</a>(<span class="keyword">sizeof</span>(new_fileio))) == <a class="code" href="tamtypes_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160; </div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        <span class="comment">/* setup our jump opcodes */</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        p_new_fileio = <a class="code" href="kernel_8h.html#a95597515b571dec5c2fbb4802b52c89a">UNCACHED_SEG</a>(new_fileio);</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160; </div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        <span class="comment">//For the sceFioRemove() patch</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        p_new_fileio[0] += ((<a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)mod_info.<a class="code" href="structsmod__mod__info__t.html#ab29a3d44cffc76417e66427cda3b6b39">text_start</a> &gt;&gt; 2);</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        p_new_fileio[2] += ((<a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)mod_info.<a class="code" href="structsmod__mod__info__t.html#ab29a3d44cffc76417e66427cda3b6b39">text_start</a> &gt;&gt; 2);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        <span class="comment">//For the sceFioGetstat() and sceFioDread() patch</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        p_new_fileio[8] += ((<a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)mod_info.<a class="code" href="structsmod__mod__info__t.html#ab29a3d44cffc76417e66427cda3b6b39">text_start</a> &gt;&gt; 2);</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        p_new_fileio[11] += ((<a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)mod_info.<a class="code" href="structsmod__mod__info__t.html#ab29a3d44cffc76417e66427cda3b6b39">text_start</a> &gt;&gt; 2);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        p_new_fileio[14] += ((<a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)mod_info.<a class="code" href="structsmod__mod__info__t.html#ab29a3d44cffc76417e66427cda3b6b39">text_start</a> &gt;&gt; 2);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160; </div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        <span class="comment">/* apply it */</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        dmat.<a class="code" href="structSifDmaTransfer__t.html#ae58a803a6593aa3ea56aae3f44cd03af">src</a>=new_fileio;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        dmat.<a class="code" href="structSifDmaTransfer__t.html#acb6defff65e747d386b28aa756c51575">dest</a>=patch_addr;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        dmat.<a class="code" href="structSifDmaTransfer__t.html#aa095dc74c5c080a1c1cfc69ee4885f87">size</a>=<span class="keyword">sizeof</span>(new_fileio);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        dmat.<a class="code" href="structSifDmaTransfer__t.html#abea4132eac1b82deda7743010469012e">attr</a>=0;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        <a class="code" href="kernel_8h.html#a2b8881e2a24bee9c3f14c7005ff1f744">SifSetDma</a>(&amp;dmat, 1);</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160; </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="comment">//For the dump to sceRemove()</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        new_jump_op =  <a class="code" href="patch__fileio_8c.html#a66fb29e35482b40260a1515f73b39a9b">JMP</a>((<a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)patch_addr);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <a class="code" href="common_8c.html#a69ca030bd7262895245b2ef2d291bd24">smem_write_word</a>((<span class="keywordtype">void</span> *)mod_info.<a class="code" href="structsmod__mod__info__t.html#ab29a3d44cffc76417e66427cda3b6b39">text_start</a> + 0x0bb8, new_jump_op);</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        new_jump_op =  <a class="code" href="patch__fileio_8c.html#ab6bbd226acccedeaac6172bb2e3afe0d">JAL</a>((<a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a>)patch_addr + 16);</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        <span class="comment">//For the jumps to sceSifSetDma within sceGetstat() and sceDread():</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        <a class="code" href="common_8c.html#a69ca030bd7262895245b2ef2d291bd24">smem_write_word</a>((<span class="keywordtype">void</span> *)mod_info.<a class="code" href="structsmod__mod__info__t.html#ab29a3d44cffc76417e66427cda3b6b39">text_start</a> + 0x09cc, new_jump_op);</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        <a class="code" href="common_8c.html#a69ca030bd7262895245b2ef2d291bd24">smem_write_word</a>((<span class="keywordtype">void</span> *)mod_info.<a class="code" href="structsmod__mod__info__t.html#ab29a3d44cffc76417e66427cda3b6b39">text_start</a> + 0x0a58, new_jump_op);</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;}</div>
<div class="ttc" id="akernel_8h_html_a95597515b571dec5c2fbb4802b52c89a"><div class="ttname"><a href="kernel_8h.html#a95597515b571dec5c2fbb4802b52c89a">UNCACHED_SEG</a></div><div class="ttdeci">#define UNCACHED_SEG(x)</div><div class="ttdef"><b>Definition:</b> <a href="kernel_8h_source.html#l00035">kernel.h:35</a></div></div>
<div class="ttc" id="apatch__fileio_8c_html_a66fb29e35482b40260a1515f73b39a9b"><div class="ttname"><a href="patch__fileio_8c.html#a66fb29e35482b40260a1515f73b39a9b">JMP</a></div><div class="ttdeci">#define JMP(addr)</div><div class="ttdef"><b>Definition:</b> <a href="patch__fileio_8c_source.html#l00012">patch_fileio.c:12</a></div></div>
<div class="ttc" id="apatch__fileio_8c_html_ab6bbd226acccedeaac6172bb2e3afe0d"><div class="ttname"><a href="patch__fileio_8c.html#ab6bbd226acccedeaac6172bb2e3afe0d">JAL</a></div><div class="ttdeci">#define JAL(addr)</div><div class="ttdef"><b>Definition:</b> <a href="patch__fileio_8c_source.html#l00013">patch_fileio.c:13</a></div></div>
<div class="ttc" id="astructsmod__mod__info__t_html_a873fac0216a06abf1d451540dba0fd11"><div class="ttname"><a href="structsmod__mod__info__t.html#a873fac0216a06abf1d451540dba0fd11">smod_mod_info_t::version</a></div><div class="ttdeci">u16 version</div><div class="ttdef"><b>Definition:</b> <a href="smod_8h_source.html#l00028">smod.h:28</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="kernel_8h_source.html#l00050">ALIGNED</a>, <a class="el" href="sifdma_8h_source.html#l00057">SifDmaTransfer_t::attr</a>, <a class="el" href="sifdma_8h_source.html#l00055">SifDmaTransfer_t::dest</a>, <a class="el" href="patch__fileio_8c_source.html#l00013">JAL</a>, <a class="el" href="patch__fileio_8c_source.html#l00012">JMP</a>, <a class="el" href="tamtypes_8h_source.html#l00091">NULL</a>, <a class="el" href="iopheap_8h.html#a3edc638fb035b452cac7f90e307651f2">SifAllocIopHeap()</a>, <a class="el" href="iopheap_8h.html#adf3f039812fac1c19289aa73460376d8">SifInitIopHeap()</a>, <a class="el" href="kernel_8h.html#a2b8881e2a24bee9c3f14c7005ff1f744">SifSetDma()</a>, <a class="el" href="sifdma_8h_source.html#l00056">SifDmaTransfer_t::size</a>, <a class="el" href="common_8c_source.html#l00040">smem_write_word()</a>, <a class="el" href="smod_8c_source.html#l00054">smod_get_mod_by_name()</a>, <a class="el" href="sifdma_8h_source.html#l00054">SifDmaTransfer_t::src</a>, <a class="el" href="smod_8h_source.html#l00036">smod_mod_info_t::text_start</a>, <a class="el" href="kernel_8h_source.html#l00035">UNCACHED_SEG</a>, and <a class="el" href="smod_8h_source.html#l00028">smod_mod_info_t::version</a>.</p>

</div>
</div>
<a id="aae2a4b6f2246429c5ead8c072d022f7b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aae2a4b6f2246429c5ead8c072d022f7b">&#9670;&nbsp;</a></span>sbv_patch_user_mem_clear()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sbv_patch_user_mem_clear </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>start</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>@start address above which all user memory is cleared </p><dl class="section return"><dt>Returns</dt><dd>0: success, -1: error</dd></dl>
<p><a class="el" href="kernel_8h.html#ad88bb7b06f1dfd390f71579da66b8b7a">LoadExecPS2()</a> wipes all user-space memory above 0x82000. With this patch, you can define a different start address to prevent your data from being overwritten. In order to completely disable the memory clear, simply pass 0x02000000 to it. </p>

<p class="definition">Definition at line <a class="el" href="patch__user__mem__clear_8c_source.html#l00009">9</a> of file <a class="el" href="patch__user__mem__clear_8c_source.html">patch_user_mem_clear.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;{</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        <span class="keywordtype">int</span> ret = -1;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        <a class="code" href="tamtypes_8h.html#a10e94b422ef0c20dcdec20d31a1f5049">u32</a> *p;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160; </div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;        <a class="code" href="kernel_8h.html#acabe1ee3d11be6214c678bf4dabda3c9">DI</a>();</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;        <a class="code" href="kernel_8h.html#a60e2c069b351a5440c6de43df8e55ceb">ee_kmode_enter</a>();</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160; </div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        <span class="keywordflow">for</span> (p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)0x80001000; p &lt; (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)0x80080000; p++) {</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;                <span class="comment">/*</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">                 * Search for function call and patch $a0</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">                 *  lui  $a0, 0x0008</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">                 *  jal  InitializeUserMemory</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">                 *  ori  $a0, $a0, 0x2000</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">                 */</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;                <span class="keywordflow">if</span> (p[0] == 0x3c040008 &amp;&amp; (p[1] &amp; 0xfc000000) == 0x0c000000 &amp;&amp; p[2] == 0x34842000) {</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;                        p[0] = 0x3c040000 | ((<span class="keywordtype">unsigned</span> int)start &gt;&gt; 16);</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;                        p[2] = 0x34840000 | ((<span class="keywordtype">unsigned</span> int)start &amp; 0xffff);</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;                        ret = 0;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;                }</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;        }</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160; </div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;        <a class="code" href="kernel_8h.html#a03c9c062167621ac977f2f749e7a7221">ee_kmode_exit</a>();</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        <a class="code" href="kernel_8h.html#ad346b022412134cee746a6099a12c674">EI</a>();</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160; </div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;        <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;}</div>
<div class="ttc" id="akernel_8h_html_a03c9c062167621ac977f2f749e7a7221"><div class="ttname"><a href="kernel_8h.html#a03c9c062167621ac977f2f749e7a7221">ee_kmode_exit</a></div><div class="ttdeci">static int ee_kmode_exit()</div><div class="ttdef"><b>Definition:</b> <a href="kernel_8h_source.html#l00198">kernel.h:198</a></div></div>
<div class="ttc" id="akernel_8h_html_a60e2c069b351a5440c6de43df8e55ceb"><div class="ttname"><a href="kernel_8h.html#a60e2c069b351a5440c6de43df8e55ceb">ee_kmode_enter</a></div><div class="ttdeci">static int ee_kmode_enter()</div><div class="ttdef"><b>Definition:</b> <a href="kernel_8h_source.html#l00181">kernel.h:181</a></div></div>
<div class="ttc" id="akernel_8h_html_acabe1ee3d11be6214c678bf4dabda3c9"><div class="ttname"><a href="kernel_8h.html#acabe1ee3d11be6214c678bf4dabda3c9">DI</a></div><div class="ttdeci">#define DI</div><div class="ttdef"><b>Definition:</b> <a href="kernel_8h_source.html#l00024">kernel.h:24</a></div></div>
<div class="ttc" id="akernel_8h_html_ad346b022412134cee746a6099a12c674"><div class="ttname"><a href="kernel_8h.html#ad346b022412134cee746a6099a12c674">EI</a></div><div class="ttdeci">#define EI</div><div class="ttdef"><b>Definition:</b> <a href="kernel_8h_source.html#l00025">kernel.h:25</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="kernel_8h_source.html#l00024">DI</a>, <a class="el" href="kernel_8h_source.html#l00181">ee_kmode_enter()</a>, <a class="el" href="kernel_8h_source.html#l00198">ee_kmode_exit()</a>, and <a class="el" href="kernel_8h_source.html#l00025">EI</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_049738f1909e8dc3e45fe1f6b3faa109.html">ee</a></li><li class="navelem"><a class="el" href="dir_3c99d3595cafa99f0e2683197c97edf9.html">sbv</a></li><li class="navelem"><a class="el" href="dir_4235aca40d92d2d6923267ff8588d97a.html">include</a></li><li class="navelem"><a class="el" href="sbv__patches_8h.html">sbv_patches.h</a></li>
    <li class="footer">Generated on Thu Feb 11 2021 11:42:26 for ps2sdk by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
